# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π

> **–ì–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: "–°–ª–æ–∏—Å—Ç–∞—è + Capabilities + Events"
> –í–µ—Ä—Å–∏—è: 1.0
> –î–∞—Ç–∞: 2026-02-02

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ñ–∞–π–ª–æ–≤)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ—ë–≤](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–ª–æ—ë–≤)
- [–ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏](#–∫–ª—é—á–µ–≤—ã–µ-–∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
- [–°–∏—Å—Ç–µ–º–∞ —ç—Ç–∞–∂–µ–π (Levels)](#—Å–∏—Å—Ç–µ–º–∞-—ç—Ç–∞–∂–µ–π-levels)
- [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
- [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞](#–º–∏–≥—Ä–∞—Ü–∏—è-—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ-–∫–æ–¥–∞)

---

## üéØ –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª—É—á—à–µ–µ –∏–∑ –¥–≤—É—Ö –ø–æ–¥—Ö–æ–¥–æ–≤:
- **–°–ª–æ–∏—Å—Ç—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** (–ø—Ä–æ—Å—Ç–æ—Ç–∞ –æ—Ç–ª–∞–¥–∫–∏, —á—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ)
- **Capabilities Pattern** (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–æ–≤)
- **Command Pattern** (–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Undo/Redo)
- **Policy Pattern** (–≥–∏–±–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞)

### –ü—Ä–∏–Ω—Ü–∏–ø—ã

‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –∫–∞–∂–¥—ã–π —Å–ª–æ–π —Ä–µ—à–∞–µ—Ç —Å–≤–æ—é –∑–∞–¥–∞—á—É
‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Ä–µ–∂–∏–º—ã
‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - –æ–±—â–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è (Behaviors) –¥–ª—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
‚úÖ **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è TypeScript
‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
src/
‚îú‚îÄ‚îÄ main.ts                            # üöÄ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îî‚îÄ‚îÄ ContextSingleton.ts           # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å–∏–Ω–≥–ª—Ç–æ–Ω–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ threeApp/
‚îÇ   ‚îú‚îÄ‚îÄ ThreeMain.ts                  # üéØ –ì–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä Three.js
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ scene/                         # üé¨ –ë–ê–ó–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ –°–¶–ï–ù–´
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SceneManager.ts           # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ THREE.Scene
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RendererManager.ts        # WebGL —Ä–µ–Ω–¥–µ—Ä–µ—Ä
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CameraManager.ts          # –î–≤–æ–π–Ω–∞—è –∫–∞–º–µ—Ä–∞ (2D/3D)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ControlsManager.ts        # OrbitControls
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LightsManager.ts          # –û—Å–≤–µ—â–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GridHelper.ts             # –°–µ—Ç–∫–∞ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PostProcessing.ts         # –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ (outline, etc.)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ house/                         # üè† –õ–û–ì–ò–ö–ê –ü–û–°–¢–†–û–ï–ù–ò–Ø –î–û–ú–ê
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HouseManager.ts           # –ì–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–º–∞ (–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HouseLoader.ts            # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–º–∞ –∏–∑ JSON
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HouseExporter.ts          # –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–æ–º–∞ –≤ JSON
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ levels/                    # üè¢ –°–∏—Å—Ç–µ–º–∞ —ç—Ç–∞–∂–µ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LevelManager.ts       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–∂–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Level.ts              # –ö–ª–∞—Å—Å —ç—Ç–∞–∂–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LevelContext.ts       # –ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç—Ç–∞–∂–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LevelVisibility.ts    # –í–∏–¥–∏–º–æ—Å—Ç—å —ç—Ç–∞–∂–µ–π (ghost/hidden)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ points/                    # üìç –¢–æ—á–∫–∏ (–≤–µ—Ä—à–∏–Ω—ã —Å—Ç–µ–Ω)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PointsManager.ts      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Point.ts              # –ö–ª–∞—Å—Å —Ç–æ—á–∫–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PointMesh.ts          # –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PointFactory.ts       # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–µ–∫
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ walls/                     # üß± –°—Ç–µ–Ω—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WallsManager.ts       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–Ω–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Wall.ts               # –ö–ª–∞—Å—Å —Å—Ç–µ–Ω—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WallGeometry.ts       # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–µ–æ–º–µ—Ç—Ä–∏–∏ —Å—Ç–µ–Ω—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WallMaterial.ts       # –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Å—Ç–µ–Ω
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WallFactory.ts        # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–µ–Ω
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rooms/                     # üö™ –ö–æ–º–Ω–∞—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoomsManager.ts       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Room.ts               # –ö–ª–∞—Å—Å –∫–æ–º–Ω–∞—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoomDetector.ts       # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç –ø–æ —Å—Ç–µ–Ω–∞–º
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RoomFloor.ts          # –ü–æ–ª –∫–æ–º–Ω–∞—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openings/                  # üö™ü™ü –î–≤–µ—Ä–∏ –∏ –æ–∫–Ω–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OpeningsManager.ts    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—ë–º–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Door.ts               # –ö–ª–∞—Å—Å –¥–≤–µ—Ä–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Window.ts             # –ö–ª–∞—Å—Å –æ–∫–Ω–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OpeningPlacer.ts      # –†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ —Å—Ç–µ–Ω–µ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OpeningCutter.ts      # –í—ã—Ä–µ–∑–∞–Ω–∏–µ –ø—Ä–æ—ë–º–æ–≤ –≤ —Å—Ç–µ–Ω–µ
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ objects/                   # ü™ë –ú–µ–±–µ–ª—å –∏ –æ–±—ä–µ–∫—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ObjectsManager.ts     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FurnitureObject.ts    # –ö–ª–∞—Å—Å –º–µ–±–µ–ª–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ObjectCatalog.ts      # –ö–∞—Ç–∞–ª–æ–≥ –æ–±—ä–µ–∫—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ObjectPlacer.ts       # –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ roofs/                     # üè† –ö—Ä—ã—à–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoofsManager.ts       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä—ã—à–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Roof.ts               # –ö–ª–∞—Å—Å –∫—Ä—ã—à–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoofGeometry.ts       # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–µ–æ–º–µ—Ç—Ä–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RoofTypes.ts          # –¢–∏–ø—ã –∫—Ä—ã—à (–ø–ª–æ—Å–∫–∞—è, –¥–≤—É—Å–∫–∞—Ç–Ω–∞—è, etc.)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stairs/                    # ü™ú –õ–µ—Å—Ç–Ω–∏—Ü—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StairsManager.ts      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–µ—Å—Ç–Ω–∏—Ü–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Stairway.ts           # –ö–ª–∞—Å—Å –ª–µ—Å—Ç–Ω–∏—Ü—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ StairTypes.ts         # –¢–∏–ø—ã –ª–µ—Å—Ç–Ω–∏—Ü
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ floors/                    # üü´ –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏—è
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ FloorsManager.ts      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è–º–∏
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ FloorSlab.ts          # –ü–ª–∏—Ç–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ FloorOpening.ts       # –ü—Ä–æ—ë–º—ã –≤ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è—Ö
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ interaction/                   # üñ±Ô∏è –°–ò–°–¢–ï–ú–ê –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ô
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InteractionOrchestrator.ts  # –ì–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EventBus.ts                 # Event Bus –¥–ª—è —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InteractionContext.ts       # –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CursorManager.ts            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–æ–º
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input/                     # üì• –°–ª–æ–π –≤–≤–æ–¥–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MouseInputManager.ts  # Mouse/touch —Å–æ–±—ã—Ç–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ KeyboardInputManager.ts # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GestureDetector.ts    # –ñ–µ—Å—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routing/                   # üö¶ –°–ª–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClickRouter.ts        # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RaycastService.ts     # Centralized raycasting
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ObjectIdentifier.ts   # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modes/                     # üé® –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ModeManager.ts        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Mode.ts               # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Ä–µ–∂–∏–º–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Camera2DMode.ts       # 2D —Ä–µ–∂–∏–º
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Camera3DMode.ts       # 3D —Ä–µ–∂–∏–º
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ViewOnlyMode.ts       # –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MeasureMode.ts        # –†–µ–∂–∏–º –∏–∑–º–µ—Ä–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ policies/                  # üîí –ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InteractionPolicy.ts  # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –ø–æ–ª–∏—Ç–∏–∫
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Camera2DPolicy.ts     # –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è 2D
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Camera3DPolicy.ts     # –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è 3D
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LevelPolicy.ts        # –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —ç—Ç–∞–∂–µ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PolicyRegistry.ts     # –†–µ–µ—Å—Ç—Ä –ø–æ–ª–∏—Ç–∏–∫
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ capabilities/              # üß© –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–æ–≤ (Mixins)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Capability.ts         # –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Draggable.ts          # –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Selectable.ts         # –ú–æ–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Snappable.ts          # –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Resizable.ts          # –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Hoverable.ts          # –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Rotatable.ts          # –ú–æ–∂–Ω–æ –≤—Ä–∞—â–∞—Ç—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Deletable.ts          # –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LevelBound.ts         # –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —ç—Ç–∞–∂—É
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.ts              # –£—Ç–∏–ª–∏—Ç—ã (applyCapabilities, hasCapability)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ features/                  # üé≠ –§–∏—á–∏ (–≥—Ä—É–ø–ø—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Feature.ts            # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Ñ–∏—á–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ points/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PointFeature.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PointDragHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PointSnapHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ walls/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WallFeature.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WallDragHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WallResizeHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WallSplitHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rooms/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoomFeature.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RoomSelectHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ objects/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ObjectFeature.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ObjectPlaceHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ObjectDragHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ObjectRotateHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openings/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OpeningFeature.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OpeningMoveHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OpeningResizeHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roofs/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ RoofFeature.ts
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ RoofEditHandler.ts
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ behaviors/                 # üîÑ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DragBehavior.ts       # –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ drag
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SnapBehavior.ts       # –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ/—Ç–æ—á–∫–∞–º
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HoverBehavior.ts      # –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OutlineBehavior.ts    # –û–±–≤–æ–¥–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CollisionBehavior.ts  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools/                     # üõ†Ô∏è –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ToolManager.ts        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SelectionTool.ts      # –í—ã–¥–µ–ª–µ–Ω–∏–µ (box selection)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MeasureTool.ts        # –ò–∑–º–µ—Ä–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TransformTool.ts      # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è (pivot/rotate/scale)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SnapTool.ts           # –ü—Ä–∏–≤—è–∑–∫–∞
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commands/                  # ‚èÆÔ∏è –ö–æ–º–∞–Ω–¥—ã –¥–ª—è Undo/Redo
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CommandManager.ts     # –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Command.ts            # –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MoveCommand.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeleteCommand.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AddCommand.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ResizeCommand.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TransformCommand.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateLevelCommand.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeleteLevelCommand.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChangeLevelCommand.ts
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ blocking/                  # üö´ –°–∏—Å—Ç–µ–º–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ BlockingManager.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ BlockingRules.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ loaders/                       # üì¶ –ó–∞–≥—Ä—É–∑—á–∏–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
‚îÇ       ‚îú‚îÄ‚îÄ ModelLoader.ts            # –ó–∞–≥—Ä—É–∑–∫–∞ 3D –º–æ–¥–µ–ª–µ–π
‚îÇ       ‚îú‚îÄ‚îÄ TextureLoader.ts          # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä
‚îÇ       ‚îî‚îÄ‚îÄ MaterialLibrary.ts        # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ ui/                                # üñºÔ∏è UI –ö–û–ú–ü–û–ù–ï–ù–¢–´
‚îÇ   ‚îú‚îÄ‚îÄ UiMain.ts                     # –ì–ª–∞–≤–Ω—ã–π UI –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ panels/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TopPanel.ts               # –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LeftPanel.ts              # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (–∫–∞—Ç–∞–ª–æ–≥)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RightPanel.ts             # –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (—Å–≤–æ–π—Å—Ç–≤–∞)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LevelPanel.ts             # –ü–∞–Ω–µ–ª—å —ç—Ç–∞–∂–µ–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PropertiesPanel.ts        # –ü–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –æ–±—ä–µ–∫—Ç–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ toolbar/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Toolbar.ts                # –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ToolButton.ts             # –ö–Ω–æ–ø–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ controls/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CameraToggle.ts           # –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å 2D/3D
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UndoRedoButtons.ts        # –ö–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã/–ø–æ–≤—Ç–æ—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ZoomControls.ts           # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ dialogs/
‚îÇ       ‚îú‚îÄ‚îÄ ConfirmDialog.ts          # –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
‚îÇ       ‚îî‚îÄ‚îÄ SettingsDialog.ts         # –î–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îÇ
‚îî‚îÄ‚îÄ utils/                             # üîß –£–¢–ò–õ–ò–¢–´
    ‚îú‚îÄ‚îÄ math/
    ‚îÇ   ‚îú‚îÄ‚îÄ GeometryUtils.ts          # –ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
    ‚îÇ   ‚îú‚îÄ‚îÄ VectorUtils.ts            # –†–∞–±–æ—Ç–∞ —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏
    ‚îÇ   ‚îî‚îÄ‚îÄ PolygonUtils.ts           # –†–∞–±–æ—Ç–∞ —Å –ø–æ–ª–∏–≥–æ–Ω–∞–º–∏
    ‚îÇ
    ‚îú‚îÄ‚îÄ helpers/
    ‚îÇ   ‚îú‚îÄ‚îÄ DebugHelper.ts            # –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    ‚îÇ   ‚îî‚îÄ‚îÄ PerformanceMonitor.ts     # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    ‚îÇ
    ‚îî‚îÄ‚îÄ types/
        ‚îú‚îÄ‚îÄ HouseTypes.ts             # –¢–∏–ø—ã –¥–ª—è –¥–æ–º–∞
        ‚îú‚îÄ‚îÄ InteractionTypes.ts       # –¢–∏–ø—ã –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
        ‚îî‚îÄ‚îÄ EventTypes.ts             # –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ—ë–≤

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USER INPUT (Mouse, Keyboard, Touch)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  INPUT LAYER: MouseInputManager, KeyboardInputManager       ‚îÇ
‚îÇ  - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π                                     ‚îÇ
‚îÇ  - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∂–µ—Å—Ç–æ–≤                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ROUTING LAYER: ClickRouter, RaycastService                 ‚îÇ
‚îÇ  - Raycasting                                               ‚îÇ
‚îÇ  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞ (point, wall, object)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  POLICY CHECK: PolicyRegistry                               ‚îÇ
‚îÇ  - –ü—Ä–æ–≤–µ—Ä–∫–∞: –º–æ–∂–Ω–æ –ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å?                   ‚îÇ
‚îÇ  - –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ?                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CAPABILITY CHECK: –û–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç –Ω—É–∂–Ω—É—é Capability?         ‚îÇ
‚îÇ  - Draggable? Selectable? Resizable?                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FEATURE LAYER: PointFeature, WallFeature, ObjectFeature    ‚îÇ
‚îÇ  - –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π Handler                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  HANDLER: PointDragHandler, WallMoveHandler, etc.           ‚îÇ
‚îÇ  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Behaviors (DragBehavior, SnapBehavior)        ‚îÇ
‚îÇ  - –°–æ–∑–¥–∞–µ—Ç Command –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ CommandManager            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  COMMAND EXECUTION: CommandManager                          ‚îÇ
‚îÇ  - –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É                                        ‚îÇ
‚îÇ  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è Undo/Redo                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  EVENT BUS: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π                      ‚îÇ
‚îÇ  - 'object:moved', 'wall:resized', 'selection:changed'      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–æ—ë–≤

#### 1. INPUT LAYER (–°–ª–æ–π –≤–≤–æ–¥–∞)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –ó–∞—Ö–≤–∞—Ç –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –≤–≤–æ–¥–∞

- **MouseInputManager**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ mouse/touch —Å–æ–±—ã—Ç–∏–π
- **KeyboardInputManager**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã—Ö shortcuts
- **GestureDetector**: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–≤ (long-press, pinch-zoom, swipe)

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏, —Ç–∏–ø–æ–º, –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏

#### 2. ROUTING LAYER (–°–ª–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–∏ —Å–æ–±—ã—Ç–∏—è

- **RaycastService**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π raycasting –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
- **ObjectIdentifier**: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ –ø–æ `userData.tag`
- **ClickRouter**: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: `{ objectType, object, event, action }`

#### 3. POLICY LAYER (–°–ª–æ–π –ø–æ–ª–∏—Ç–∏–∫)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π

- **PolicyRegistry**: –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É
- **InteractionPolicy**: –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –ø–æ–ª–∏—Ç–∏–∫
- **Camera2DPolicy/Camera3DPolicy**: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: `boolean` (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ/–∑–∞–ø—Ä–µ—â–µ–Ω–æ)

#### 4. CAPABILITY LAYER (–°–ª–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –æ–±—ä–µ–∫—Ç–∞

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ capability –≤ `object.userData.capabilities`
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: `boolean` (–æ–±—ä–µ–∫—Ç –∏–º–µ–µ—Ç/–Ω–µ –∏–º–µ–µ—Ç capability)

#### 5. FEATURE LAYER (–°–ª–æ–π —Ñ–∏—á)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ —Ç–∏–ø–∞–º –æ–±—ä–µ–∫—Ç–æ–≤

- **PointFeature**: –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Ç–æ—á–µ–∫
- **WallFeature**: –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Å—Ç–µ–Ω
- **ObjectFeature**: –£–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –æ–±—ä–µ–∫—Ç–æ–≤

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π Handler

#### 6. HANDLER LAYER (–°–ª–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **Behaviors** –¥–ª—è –æ–±—â–µ–π –ª–æ–≥–∏–∫–∏
- –°–æ–∑–¥–∞—ë—Ç **Command** –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (isDown, isMove, selectedObject)

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: Command –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### 7. COMMAND LAYER (–°–ª–æ–π –∫–æ–º–∞–Ω–¥)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

- **CommandManager**: –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏–µ–π
- **Command**: –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –º–µ—Ç–æ–¥–∞–º–∏ execute/undo/redo
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Undo/Redo

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ü–µ–Ω–µ + –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é

#### 8. EVENT BUS (–®–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π)
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –ú–µ–∂–º–æ–¥—É–ª—å–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏
- –°–æ–±—ã—Ç–∏—è: `object:moved`, `camera:switched`, `selection:changed`

---

## üí° –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 1. –†–µ–∂–∏–º—ã (Modes)

–†–µ–∂–∏–º—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

```typescript
// modes/Mode.ts
export abstract class Mode {
  abstract name: string;
  abstract enabledFeatures: string[];
  abstract policy: InteractionPolicy;

  abstract onActivate(): void;
  abstract onDeactivate(): void;
}
```

**–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∂–∏–º–æ–≤:**
- **Camera2DMode**: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ 2D (—Ç–æ—á–∫–∏, —Å—Ç–µ–Ω—ã, –∫–æ–º–Ω–∞—Ç—ã)
- **Camera3DMode**: –ü—Ä–æ—Å–º–æ—Ç—Ä –≤ 3D + —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
- **ViewOnlyMode**: –¢–æ–ª—å–∫–æ –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **MeasureMode**: –ò–∑–º–µ—Ä–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –∏ –ø–ª–æ—â–∞–¥–µ–π

```typescript
// modes/Camera2DMode.ts
export class Camera2DMode extends Mode {
  name = '2D';
  enabledFeatures = ['points', 'walls', 'rooms'];
  policy = new Camera2DPolicy();

  onActivate() {
    ToolManager.inst().enableTools(['snap', 'measure']);
    CursorManager.inst().setCursor('default');
  }

  onDeactivate() {
    // Cleanup
  }
}
```

### 2. –ü–æ–ª–∏—Ç–∏–∫–∏ (Policies)

–ü–æ–ª–∏—Ç–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∂–∏–º–∞.

```typescript
// policies/InteractionPolicy.ts
export abstract class InteractionPolicy {
  abstract allows(action: string, objectType: string): boolean;
}
```

```typescript
// policies/Camera2DPolicy.ts
export class Camera2DPolicy extends InteractionPolicy {
  private rules = {
    drag: ['point', 'wall'],
    select: ['point', 'wall', 'room'],
    delete: ['point', 'wall'],
    resize: ['wall'],
  };

  allows(action: string, objectType: string): boolean {
    const allowedTypes = this.rules[action];
    return allowedTypes?.includes(objectType) ?? false;
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
const policy = ModeManager.inst().getCurrentMode().policy;
if (policy.allows('drag', 'point')) {
  // –†–∞–∑—Ä–µ—à–µ–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å —Ç–æ—á–∫–∏
}
```

### 3. Capabilities (–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)

Capabilities –¥–æ–±–∞–≤–ª—è—é—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞–º —á–µ—Ä–µ–∑ –º–∏–∫—Å–∏–Ω—ã.

```typescript
// capabilities/Capability.ts
export interface Capability {
  type: string;
  attach(object: THREE.Object3D): void;
  detach(object: THREE.Object3D): void;
}
```

```typescript
// capabilities/Draggable.ts
export class Draggable implements Capability {
  type = 'draggable';

  attach(object: THREE.Object3D) {
    object.userData.capabilities = object.userData.capabilities || [];
    if (!object.userData.capabilities.includes('draggable')) {
      object.userData.capabilities.push('draggable');
    }
  }

  detach(object: THREE.Object3D) {
    const caps = object.userData.capabilities || [];
    const index = caps.indexOf('draggable');
    if (index > -1) {
      caps.splice(index, 1);
    }
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∫ –æ–±—ä–µ–∫—Ç—É
const pointMesh = createPoint();
applyCapabilities(pointMesh, [
  new Draggable(),
  new Selectable(),
  new Snappable()
]);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
if (hasCapability(object, 'draggable')) {
  // –û–±—ä–µ–∫—Ç –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å
}
```

**–£—Ç–∏–ª–∏—Ç—ã:**
```typescript
// capabilities/utils.ts
export function applyCapabilities(
  object: THREE.Object3D,
  capabilities: Capability[]
) {
  capabilities.forEach(cap => cap.attach(object));
}

export function hasCapability(
  object: THREE.Object3D,
  capabilityType: string
): boolean {
  const caps = object.userData.capabilities || [];
  return caps.includes(capabilityType);
}
```

### 4. Features (–§–∏—á–∏)

Features –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ —Ç–∏–ø–∞–º –æ–±—ä–µ–∫—Ç–æ–≤.

```typescript
// features/Feature.ts
export abstract class Feature {
  abstract name: string;
  protected handlers: Map<string, any> = new Map();
  protected enabled: boolean = false;

  abstract init(): void;

  enable() {
    this.enabled = true;
    this.handlers.forEach(h => h.enable?.());
  }

  disable() {
    this.enabled = false;
    this.handlers.forEach(h => h.disable?.());
  }

  handle(event: any, object: THREE.Object3D) {
    if (!this.enabled) return;

    const action = event.action; // 'drag', 'select', 'resize', etc.
    const handler = this.handlers.get(action);

    if (handler) {
      handler.handle(event, object);
    }
  }
}
```

```typescript
// features/points/PointFeature.ts
export class PointFeature extends Feature {
  name = 'points';

  init() {
    this.handlers.set('drag', new PointDragHandler());
    this.handlers.set('snap', new PointSnapHandler());
  }
}
```

### 5. Behaviors (–ü–æ–≤–µ–¥–µ–Ω–∏—è)

Behaviors —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—É—é –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

```typescript
// behaviors/DragBehavior.ts
export class DragBehavior {
  private plane: THREE.Plane;
  private offset: THREE.Vector3;

  startDrag(object: THREE.Object3D, event: PointerEvent) {
    // –°–æ–∑–¥–∞—ë–º –ø–ª–æ—Å–∫–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–±—ä–µ–∫—Ç–∞
    this.plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), -object.position.y);

    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(getNormalizedCoords(event), camera);

    const intersection = new THREE.Vector3();
    raycaster.ray.intersectPlane(this.plane, intersection);

    this.offset = intersection.clone().sub(object.position);
  }

  updateDrag(object: THREE.Object3D, event: PointerEvent): THREE.Vector3 {
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(getNormalizedCoords(event), camera);

    const intersection = new THREE.Vector3();
    raycaster.ray.intersectPlane(this.plane, intersection);

    return intersection.sub(this.offset);
  }

  endDrag() {
    this.plane = null;
    this.offset = null;
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Handler:**
```typescript
// features/points/PointDragHandler.ts
export class PointDragHandler {
  private dragBehavior = new DragBehavior();
  private snapBehavior = new SnapBehavior();

  handleMouseDown(event: PointerEvent, object: THREE.Object3D) {
    this.dragBehavior.startDrag(object, event);
  }

  handleMouseMove(event: PointerEvent, object: THREE.Object3D) {
    let newPos = this.dragBehavior.updateDrag(object, event);

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∏–≤—è–∑–∫—É –∫ —Å–µ—Ç–∫–µ
    newPos = this.snapBehavior.snapToGrid(newPos, 0.1);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
    object.position.copy(newPos);
  }
}
```

### 6. Commands (–ö–æ–º–∞–Ω–¥—ã)

Commands —Ä–µ–∞–ª–∏–∑—É—é—Ç –ø–∞—Ç—Ç–µ—Ä–Ω Command –¥–ª—è Undo/Redo.

```typescript
// commands/Command.ts
export interface Command {
  execute(): void;
  undo(): void;
  redo(): void;
  canMerge?(other: Command): boolean;
  merge?(other: Command): void;
}
```

```typescript
// commands/MoveCommand.ts
export class MoveCommand implements Command {
  constructor(
    private object: THREE.Object3D,
    private oldPosition: THREE.Vector3,
    private newPosition: THREE.Vector3
  ) {}

  execute() {
    this.object.position.copy(this.newPosition);
    EventBus.emit('object:moved', { object: this.object });
  }

  undo() {
    this.object.position.copy(this.oldPosition);
    EventBus.emit('object:moved', { object: this.object });
  }

  redo() {
    this.execute();
  }

  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π
  canMerge(other: Command): boolean {
    return other instanceof MoveCommand && other.object === this.object;
  }

  merge(other: MoveCommand) {
    this.newPosition = other.newPosition.clone();
  }
}
```

**CommandManager:**
```typescript
// commands/CommandManager.ts
export class CommandManager extends ContextSingleton {
  private history: Command[] = [];
  private currentIndex: number = -1;
  private maxHistorySize: number = 100;

  execute(command: Command) {
    // –£–¥–∞–ª—è–µ–º "–±—É–¥—É—â–µ–µ" –µ—Å–ª–∏ –º—ã –Ω–µ –≤ –∫–æ–Ω—Ü–µ –∏—Å—Ç–æ—Ä–∏–∏
    if (this.currentIndex < this.history.length - 1) {
      this.history = this.history.slice(0, this.currentIndex + 1);
    }

    // –ü—ã—Ç–∞–µ–º—Å—è –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–º–∞–Ω–¥–æ–π
    const lastCommand = this.history[this.currentIndex];
    if (lastCommand?.canMerge?.(command)) {
      lastCommand.merge(command);
      command.execute();
      return;
    }

    // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
    command.execute();

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    this.history.push(command);
    this.currentIndex++;

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
    if (this.history.length > this.maxHistorySize) {
      this.history.shift();
      this.currentIndex--;
    }

    EventBus.emit('history:changed', {
      canUndo: this.canUndo(),
      canRedo: this.canRedo()
    });
  }

  undo() {
    if (!this.canUndo()) return;

    const command = this.history[this.currentIndex];
    command.undo();
    this.currentIndex--;

    EventBus.emit('history:changed', {
      canUndo: this.canUndo(),
      canRedo: this.canRedo()
    });
  }

  redo() {
    if (!this.canRedo()) return;

    this.currentIndex++;
    const command = this.history[this.currentIndex];
    command.redo();

    EventBus.emit('history:changed', {
      canUndo: this.canUndo(),
      canRedo: this.canRedo()
    });
  }

  canUndo(): boolean {
    return this.currentIndex >= 0;
  }

  canRedo(): boolean {
    return this.currentIndex < this.history.length - 1;
  }

  clear() {
    this.history = [];
    this.currentIndex = -1;
  }
}
```

### 7. Tools (–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)

Tools - —ç—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–∞—Ö.

```typescript
// tools/ToolManager.ts
export class ToolManager extends ContextSingleton {
  private tools: Map<string, Tool> = new Map();
  private activeTool: Tool | null = null;

  registerTool(name: string, tool: Tool) {
    this.tools.set(name, tool);
  }

  activateTool(name: string) {
    if (this.activeTool) {
      this.activeTool.deactivate();
    }

    const tool = this.tools.get(name);
    if (tool) {
      tool.activate();
      this.activeTool = tool;
      EventBus.emit('tool:activated', { name });
    }
  }

  deactivateTool() {
    if (this.activeTool) {
      this.activeTool.deactivate();
      this.activeTool = null;
      EventBus.emit('tool:deactivated');
    }
  }
}
```

```typescript
// tools/MeasureTool.ts
export class MeasureTool implements Tool {
  private line: THREE.Line | null = null;
  private points: THREE.Vector3[] = [];

  activate() {
    CursorManager.inst().setCursor('crosshair');
    EventBus.on('click', this.handleClick);
  }

  deactivate() {
    this.clear();
    CursorManager.inst().setCursor('default');
    EventBus.off('click', this.handleClick);
  }

  handleClick = (event: PointerEvent) => {
    const intersection = RaycastService.inst().getIntersection(event);
    if (!intersection) return;

    this.points.push(intersection.point);

    if (this.points.length === 2) {
      const distance = this.points[0].distanceTo(this.points[1]);
      console.log(`Distance: ${distance.toFixed(2)} units`);
      this.showMeasurement(distance);
      this.clear();
    }
  }

  private showMeasurement(distance: number) {
    // –ü–æ–∫–∞–∑–∞—Ç—å UI —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
  }

  private clear() {
    this.points = [];
    if (this.line) {
      this.line.removeFromParent();
      this.line = null;
    }
  }
}
```

### 8. Blocking System (–°–∏—Å—Ç–µ–º–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)

–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏.

```typescript
// blocking/BlockingManager.ts
export class BlockingManager extends ContextSingleton {
  private blocks: Map<string, Set<string>> = new Map();

  block(category: string, type: string) {
    if (!this.blocks.has(category)) {
      this.blocks.set(category, new Set());
    }
    this.blocks.get(category)!.add(type);

    EventBus.emit('blocking:changed', { category, type, blocked: true });
  }

  unblock(category: string, type: string) {
    const categoryBlocks = this.blocks.get(category);
    if (categoryBlocks) {
      categoryBlocks.delete(type);
      EventBus.emit('blocking:changed', { category, type, blocked: false });
    }
  }

  isBlocked(category: string, type: string): boolean {
    return this.blocks.get(category)?.has(type) ?? false;
  }

  clearCategory(category: string) {
    this.blocks.delete(category);
  }

  clearAll() {
    this.blocks.clear();
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å —Ç–æ—á–∫–∞–º–∏ –≤–æ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ —Å—Ç–µ–Ω–∞–º–∏
BlockingManager.inst().block('click', 'point');
BlockingManager.inst().block('hover', 'point');

// ... –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ...

BlockingManager.inst().unblock('click', 'point');
BlockingManager.inst().unblock('hover', 'point');
```

### 9. InteractionOrchestrator (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä)

–ì–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

```typescript
// core/InteractionOrchestrator.ts
export class InteractionOrchestrator extends ContextSingleton {
  private features: Map<string, Feature> = new Map();
  private modeManager: ModeManager;
  private clickRouter: ClickRouter;
  private blockingManager: BlockingManager;

  init() {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏—á
    this.registerFeature(new PointFeature());
    this.registerFeature(new WallFeature());
    this.registerFeature(new ObjectFeature());
    this.registerFeature(new RoomFeature());

    this.features.forEach(f => f.init());

    // 2. Routing
    this.clickRouter = ClickRouter.inst();
    this.clickRouter.onRouted((routeData) => {
      this.handleInteraction(routeData);
    });

    // 3. Mode management
    this.modeManager = ModeManager.inst();
    this.modeManager.onModeChange((mode) => {
      this.switchMode(mode);
    });

    // 4. Blocking
    this.blockingManager = BlockingManager.inst();

    // 5. –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
    this.subscribeToEvents();
  }

  private registerFeature(feature: Feature) {
    this.features.set(feature.name, feature);
  }

  private handleInteraction(routeData: RouteData) {
    const { objectType, action, event, object } = routeData;

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
    if (this.blockingManager.isBlocked('click', objectType)) {
      return;
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Policy
    const mode = this.modeManager.getCurrentMode();
    if (!mode.policy.allows(action, objectType)) {
      return;
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Capability
    if (!hasCapability(object, action)) {
      return;
    }

    // 4. –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Feature
    const feature = this.features.get(objectType);
    if (feature && feature.enabled) {
      feature.handle(event, object);
    }
  }

  private switchMode(mode: Mode) {
    // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
    const prevMode = this.modeManager.getPreviousMode();
    if (prevMode) {
      prevMode.onDeactivate();
    }

    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
    mode.onActivate();

    // –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∏—á
    this.features.forEach((feature, name) => {
      if (mode.enabledFeatures.includes(name)) {
        feature.enable();
      } else {
        feature.disable();
      }
    });

    EventBus.emit('mode:changed', { mode: mode.name });
  }

  private subscribeToEvents() {
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
    EventBus.on('camera:switched', ({ cameraMode }) => {
      if (cameraMode === '2D') {
        this.modeManager.setMode(new Camera2DMode());
      } else if (cameraMode === '3D') {
        this.modeManager.setMode(new Camera3DMode());
      }
    });
  }
}
```

---

## üè¢ –°–∏—Å—Ç–µ–º–∞ —ç—Ç–∞–∂–µ–π (Levels)

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–≥–æ—ç—Ç–∞–∂–Ω—ã–µ –∑–¥–∞–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç—Ç–∞–∂–∞.

### –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Å —ç—Ç–∞–∂–∞–º–∏

1. **–û–±—ä–µ–∫—Ç—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–∞–∂–∞–º** —á–µ—Ä–µ–∑ `userData.levelId`
2. **–ê–∫—Ç–∏–≤–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —ç—Ç–∞–∂** –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏
3. **–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —ç—Ç–∞–∂–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã** –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —á–µ—Ä–µ–∑ `LevelPolicy`
4. **–í–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è** - –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —ç—Ç–∞–∂–∏ –º–æ–≥—É—Ç –±—ã—Ç—å ghost/hidden/wireframe
5. **–í 3D –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å –≤—Å–µ —ç—Ç–∞–∂–∏**, –Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π
6. **Commands —Å–æ—Ö—Ä–∞–Ω—è—é—Ç levelId** –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ Undo/Redo

### 10. LevelManager (–ú–µ–Ω–µ–¥–∂–µ—Ä —ç—Ç–∞–∂–µ–π)

–ì–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç—Ç–∞–∂–∞–º–∏.

```typescript
// house/levels/LevelManager.ts
export class LevelManager extends ContextSingleton {
  private levels: Map<string, Level> = new Map();
  private activeLevel: Level | null = null;

  // –°–æ–∑–¥–∞–Ω–∏–µ —ç—Ç–∞–∂–∞
  createLevel(id: string, options: LevelOptions): Level {
    const level = new Level(id, options);
    this.levels.set(id, level);

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ç—Ç–∞–∂–∞ –Ω–∞ —Å—Ü–µ–Ω—É
    SceneManager.inst().scene.add(level.container);

    EventBus.emit('level:created', { level });
    return level;
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–∞–∂–∞
  deleteLevel(levelId: string): boolean {
    const level = this.levels.get(levelId);
    if (!level) return false;

    // –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ç–∞–∂
    if (level === this.activeLevel) {
      console.warn('Cannot delete active level');
      return false;
    }

    // –£–¥–∞–ª—è–µ–º —Å —Å—Ü–µ–Ω—ã
    SceneManager.inst().scene.remove(level.container);
    level.dispose();

    this.levels.delete(levelId);
    EventBus.emit('level:deleted', { levelId });
    return true;
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç—Ç–∞–∂–∞
  setActiveLevel(levelId: string) {
    const prevLevel = this.activeLevel;
    const newLevel = this.levels.get(levelId);

    if (!newLevel) {
      console.warn(`Level ${levelId} not found`);
      return;
    }

    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç—Ç–∞–∂
    if (prevLevel) {
      prevLevel.setActive(false);
      LevelVisibility.inst().setVisibility(prevLevel, 'ghost');
    }

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —ç—Ç–∞–∂
    newLevel.setActive(true);
    LevelVisibility.inst().setVisibility(newLevel, 'full');
    this.activeLevel = newLevel;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –¥—Ä—É–≥–∏—Ö —ç—Ç–∞–∂–µ–π –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
    BlockingManager.inst().setLevelBlock(levelId);

    EventBus.emit('level:changed', {
      from: prevLevel?.id,
      to: newLevel.id
    });
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç—Ç–∞–∂–∞
  getActiveLevel(): Level | null {
    return this.activeLevel;
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç—Ç–∞–∂–∞ –ø–æ ID
  getLevel(levelId: string): Level | undefined {
    return this.levels.get(levelId);
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–∂–µ–π
  getAllLevels(): Level[] {
    return Array.from(this.levels.values())
      .sort((a, b) => a.elevation - b.elevation); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—ã—Å–æ—Ç–µ
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç—Ç–∞–∂–∞ –≤—ã—à–µ/–Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–≥–æ
  getLevelAbove(levelId: string): Level | undefined {
    const levels = this.getAllLevels();
    const currentIndex = levels.findIndex(l => l.id === levelId);
    return levels[currentIndex + 1];
  }

  getLevelBelow(levelId: string): Level | undefined {
    const levels = this.getAllLevels();
    const currentIndex = levels.findIndex(l => l.id === levelId);
    return levels[currentIndex - 1];
  }

  // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–∂–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ)
  copyLevel(sourceLevelId: string, newId: string, newElevation: number): Level | null {
    const sourceLevel = this.levels.get(sourceLevelId);
    if (!sourceLevel) return null;

    const newLevel = this.createLevel(newId, {
      name: `${sourceLevel.name} (–∫–æ–ø–∏—è)`,
      height: sourceLevel.height,
      elevation: newElevation
    });

    // –ö–æ–ø–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã (—Ç–æ—á–∫–∏, —Å—Ç–µ–Ω—ã, –∫–æ–º–Ω–∞—Ç—ã)
    sourceLevel.copyObjectsTo(newLevel);

    return newLevel;
  }
}
```

### 11. Level (–ö–ª–∞—Å—Å —ç—Ç–∞–∂–∞)

–ö–ª–∞—Å—Å, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç—Ç–∞–∂ –∑–¥–∞–Ω–∏—è.

```typescript
// house/levels/Level.ts
export interface LevelOptions {
  name?: string;
  height?: number;      // –í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–∞ —ç—Ç–∞–∂–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2.8–º)
  elevation?: number;   // –í—ã—Å–æ—Ç–∞ –æ—Ç –∑–µ–º–ª–∏ (Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ø–æ–ª–∞)
}

export class Level {
  id: string;
  name: string;
  height: number;
  elevation: number;
  isActive: boolean = false;

  // –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ç—Ç–∞–∂–∞
  container: THREE.Group;

  // –ü–æ–¥–≥—Ä—É–ø–ø—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤
  pointsGroup: THREE.Group;
  wallsGroup: THREE.Group;
  roomsGroup: THREE.Group;
  objectsGroup: THREE.Group;
  doorsWindowsGroup: THREE.Group;

  // –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ —ç—Ç–∞–∂–∞–º–∏
  stairways: Stairway[] = [];      // –õ–µ—Å—Ç–Ω–∏—Ü—ã –Ω–∞ —ç—Ç–æ—Ç —ç—Ç–∞–∂
  openings: FloorOpening[] = [];   // –ü—Ä–æ—ë–º—ã –≤ –ø–æ–ª—É/–ø–æ—Ç–æ–ª–∫–µ

  constructor(id: string, options: LevelOptions = {}) {
    this.id = id;
    this.name = options.name || `–≠—Ç–∞–∂ ${id}`;
    this.height = options.height || 2.8;
    this.elevation = options.elevation || 0;

    // –°–æ–∑–¥–∞—ë–º –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    this.container = new THREE.Group();
    this.container.name = `level-${id}`;
    this.container.position.y = this.elevation;
    this.container.userData.levelId = this.id;
    this.container.userData.isLevel = true;

    // –°–æ–∑–¥–∞—ë–º –ø–æ–¥–≥—Ä—É–ø–ø—ã
    this.pointsGroup = new THREE.Group();
    this.pointsGroup.name = 'points';

    this.wallsGroup = new THREE.Group();
    this.wallsGroup.name = 'walls';

    this.roomsGroup = new THREE.Group();
    this.roomsGroup.name = 'rooms';

    this.objectsGroup = new THREE.Group();
    this.objectsGroup.name = 'objects';

    this.doorsWindowsGroup = new THREE.Group();
    this.doorsWindowsGroup.name = 'doors-windows';

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–≥—Ä—É–ø–ø—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    this.container.add(
      this.pointsGroup,
      this.wallsGroup,
      this.roomsGroup,
      this.objectsGroup,
      this.doorsWindowsGroup
    );
  }

  setActive(active: boolean) {
    this.isActive = active;
    this.container.userData.isActive = active;
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —ç—Ç–∞–∂
  addPoint(point: PointWall) {
    point.mesh.userData.levelId = this.id;
    this.pointsGroup.add(point.mesh);
  }

  addWall(wall: Wall) {
    wall.mesh.userData.levelId = this.id;
    this.wallsGroup.add(wall.mesh);
  }

  addRoom(room: Room) {
    room.mesh.userData.levelId = this.id;
    this.roomsGroup.add(room.mesh);
  }

  addObject(obj: THREE.Object3D) {
    obj.userData.levelId = this.id;
    this.objectsGroup.add(obj);
  }

  addDoorWindow(dw: DoorWindow) {
    dw.mesh.userData.levelId = this.id;
    this.doorsWindowsGroup.add(dw.mesh);
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
  removePoint(point: PointWall) {
    this.pointsGroup.remove(point.mesh);
  }

  removeWall(wall: Wall) {
    this.wallsGroup.remove(wall.mesh);
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
  getPoints(): THREE.Object3D[] {
    return this.pointsGroup.children;
  }

  getWalls(): THREE.Object3D[] {
    return this.wallsGroup.children;
  }

  getRooms(): THREE.Object3D[] {
    return this.roomsGroup.children;
  }

  getObjects(): THREE.Object3D[] {
    return this.objectsGroup.children;
  }

  // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –¥—Ä—É–≥–æ–π —ç—Ç–∞–∂
  copyObjectsTo(targetLevel: Level) {
    // –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ—á–∫–∏
    this.pointsGroup.children.forEach(pointMesh => {
      const newPoint = PointsManager.inst().createPointFromMesh(pointMesh, targetLevel);
      targetLevel.addPoint(newPoint);
    });

    // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–µ–Ω—ã (–ø–æ—Å–ª–µ —Ç–æ—á–µ–∫, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å —Å –Ω–æ–≤—ã–º–∏ —Ç–æ—á–∫–∞–º–∏)
    this.wallsGroup.children.forEach(wallMesh => {
      const newWall = WallsManager.inst().createWallFromMesh(wallMesh, targetLevel);
      targetLevel.addWall(newWall);
    });

    // –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–º–Ω–∞—Ç—ã
    this.roomsGroup.children.forEach(roomMesh => {
      const newRoom = RoomsManager.inst().createRoomFromMesh(roomMesh, targetLevel);
      targetLevel.addRoom(newRoom);
    });
  }

  // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
  dispose() {
    this.container.traverse((object) => {
      if (object instanceof THREE.Mesh) {
        object.geometry?.dispose();
        if (object.material instanceof THREE.Material) {
          object.material.dispose();
        }
      }
    });

    this.container.clear();
  }
}
```

### 12. LevelVisibility (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é)

–£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —ç—Ç–∞–∂–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞.

```typescript
// house/levels/LevelVisibility.ts
export type VisibilityMode = 'full' | 'ghost' | 'wireframe' | 'hidden';

export interface VisibilitySettings {
  showBelowLevels: boolean;    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç—Ç–∞–∂–∏ –Ω–∏–∂–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
  showAboveLevels: boolean;    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç—Ç–∞–∂–∏ –≤—ã—à–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
  belowMode: VisibilityMode;   // –†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∏–∂–Ω–∏—Ö —ç—Ç–∞–∂–µ–π
  aboveMode: VisibilityMode;   // –†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–µ—Ä—Ö–Ω–∏—Ö —ç—Ç–∞–∂–µ–π
  ghostOpacity: number;        // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è —Ä–µ–∂–∏–º–∞ ghost
}

export class LevelVisibility extends ContextSingleton {
  private originalMaterials: Map<THREE.Object3D, THREE.Material | THREE.Material[]> = new Map();

  private settings: VisibilitySettings = {
    showBelowLevels: true,
    showAboveLevels: false,
    belowMode: 'ghost',
    aboveMode: 'hidden',
    ghostOpacity: 0.2
  };

  setSettings(settings: Partial<VisibilitySettings>) {
    this.settings = { ...this.settings, ...settings };
    this.applyVisibilityToAllLevels();
  }

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–∂–∞
  setVisibility(level: Level, mode: VisibilityMode) {
    level.container.traverse((object) => {
      if (object instanceof THREE.Mesh) {
        switch (mode) {
          case 'full':
            this.restoreMaterial(object);
            object.visible = true;
            break;

          case 'ghost':
            this.makeGhost(object, this.settings.ghostOpacity);
            object.visible = true;
            break;

          case 'wireframe':
            this.makeWireframe(object);
            object.visible = true;
            break;

          case 'hidden':
            object.visible = false;
            break;
        }
      }
    });

    EventBus.emit('level:visibility', { levelId: level.id, mode });
  }

  // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–æ –≤—Å–µ–º —ç—Ç–∞–∂–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  applyVisibilityToAllLevels() {
    const activeLevel = LevelManager.inst().getActiveLevel();
    if (!activeLevel) return;

    LevelManager.inst().getAllLevels().forEach(level => {
      if (level.id === activeLevel.id) {
        // –ê–∫—Ç–∏–≤–Ω—ã–π —ç—Ç–∞–∂ –≤—Å–µ–≥–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–∏–º
        this.setVisibility(level, 'full');
      } else if (level.elevation < activeLevel.elevation) {
        // –≠—Ç–∞–∂–∏ –Ω–∏–∂–µ
        if (this.settings.showBelowLevels) {
          this.setVisibility(level, this.settings.belowMode);
        } else {
          this.setVisibility(level, 'hidden');
        }
      } else {
        // –≠—Ç–∞–∂–∏ –≤—ã—à–µ
        if (this.settings.showAboveLevels) {
          this.setVisibility(level, this.settings.aboveMode);
        } else {
          this.setVisibility(level, 'hidden');
        }
      }
    });
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —ç—Ç–∞–∂–∏ (–¥–ª—è 3D –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
  showAllLevels(mode: VisibilityMode = 'full') {
    LevelManager.inst().getAllLevels().forEach(level => {
      this.setVisibility(level, mode);
    });
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ç–∞–∂
  showOnlyActiveLevel() {
    const activeLevel = LevelManager.inst().getActiveLevel();

    LevelManager.inst().getAllLevels().forEach(level => {
      if (level.id === activeLevel?.id) {
        this.setVisibility(level, 'full');
      } else {
        this.setVisibility(level, 'hidden');
      }
    });
  }

  // –°–¥–µ–ª–∞—Ç—å –æ–±—ä–µ–∫—Ç –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º
  private makeGhost(mesh: THREE.Mesh, opacity: number) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
    if (!this.originalMaterials.has(mesh)) {
      this.originalMaterials.set(mesh, mesh.material);
    }

    // –°–æ–∑–¥–∞—ë–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—É—é –∫–æ–ø–∏—é –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    const material = mesh.material as THREE.Material;
    const ghostMaterial = material.clone();
    ghostMaterial.transparent = true;
    ghostMaterial.opacity = opacity;
    ghostMaterial.depthWrite = false; // –ß—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏

    mesh.material = ghostMaterial;
  }

  // –°–¥–µ–ª–∞—Ç—å –æ–±—ä–µ–∫—Ç wireframe
  private makeWireframe(mesh: THREE.Mesh) {
    if (!this.originalMaterials.has(mesh)) {
      this.originalMaterials.set(mesh, mesh.material);
    }

    const wireframeMaterial = new THREE.MeshBasicMaterial({
      color: 0x888888,
      wireframe: true,
      transparent: true,
      opacity: 0.5
    });

    mesh.material = wireframeMaterial;
  }

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
  private restoreMaterial(mesh: THREE.Mesh) {
    const original = this.originalMaterials.get(mesh);
    if (original) {
      // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
      if (mesh.material instanceof THREE.Material) {
        mesh.material.dispose();
      }

      mesh.material = original;
      this.originalMaterials.delete(mesh);
    }

    mesh.visible = true;
  }

  // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
  clearCache() {
    this.originalMaterials.clear();
  }
}
```

### 13. LevelPolicy (–ü–æ–ª–∏—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–∞–∂–∞–º)

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –æ–±—ä–µ–∫—Ç–æ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —ç—Ç–∞–∂–∞.

```typescript
// interaction/policies/LevelPolicy.ts
export class LevelPolicy {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞: –º–æ–∂–Ω–æ –ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –æ–±—ä–µ–∫—Ç–æ–º?
  static canInteract(object: THREE.Object3D): boolean {
    const objectLevelId = this.getObjectLevelId(object);
    const activeLevelId = LevelManager.inst().getActiveLevel()?.id;

    // –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —ç—Ç–∞–∂—É - —Ä–∞–∑—Ä–µ—à–∞–µ–º (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
    if (!objectLevelId) {
      return true;
    }

    // –ú–æ–∂–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç—Ç–∞–∂–∞
    return objectLevelId === activeLevelId;
  }

  // –ü–æ–ª—É—á–∏—Ç—å levelId –æ–±—ä–µ–∫—Ç–∞ (–∏—â–µ–º –≤–≤–µ—Ä—Ö –ø–æ –∏–µ—Ä–∞—Ä—Ö–∏–∏)
  static getObjectLevelId(object: THREE.Object3D): string | null {
    let current: THREE.Object3D | null = object;

    while (current) {
      if (current.userData.levelId) {
        return current.userData.levelId;
      }
      current = current.parent;
    }

    return null;
  }

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ –æ–±—ä–µ–∫—Ç –∞–∫—Ç–∏–≤–Ω–æ–º—É —ç—Ç–∞–∂—É
  static isOnActiveLevel(object: THREE.Object3D): boolean {
    const objectLevelId = this.getObjectLevelId(object);
    const activeLevelId = LevelManager.inst().getActiveLevel()?.id;

    return objectLevelId === activeLevelId;
  }

  // –ü–æ–ª—É—á–∏—Ç—å Level –æ–±—ä–µ–∫—Ç–∞
  static getObjectLevel(object: THREE.Object3D): Level | null {
    const levelId = this.getObjectLevelId(object);
    if (!levelId) return null;

    return LevelManager.inst().getLevel(levelId) || null;
  }
}
```

### 14. LevelBound Capability

Capability –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –æ–±—ä–µ–∫—Ç–∞ –∫ —ç—Ç–∞–∂—É.

```typescript
// interaction/capabilities/LevelBound.ts
export class LevelBound implements Capability {
  type = 'level-bound';

  constructor(private levelId: string) {}

  attach(object: THREE.Object3D) {
    object.userData.levelId = this.levelId;
    object.userData.capabilities = object.userData.capabilities || [];

    if (!object.userData.capabilities.includes('level-bound')) {
      object.userData.capabilities.push('level-bound');
    }
  }

  detach(object: THREE.Object3D) {
    delete object.userData.levelId;

    const caps = object.userData.capabilities || [];
    const index = caps.indexOf('level-bound');
    if (index > -1) {
      caps.splice(index, 1);
    }
  }

  // –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –∫ –¥—Ä—É–≥–æ–º—É —ç—Ç–∞–∂—É
  static changeLevel(object: THREE.Object3D, newLevelId: string) {
    object.userData.levelId = newLevelId;
    EventBus.emit('object:level-changed', { object, levelId: newLevelId });
  }
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å InteractionOrchestrator

```typescript
// core/InteractionOrchestrator.ts - –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π handleInteraction
private handleInteraction(routeData: RouteData) {
  const { objectType, action, event, object } = routeData;

  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
  if (this.blockingManager.isBlocked('click', objectType)) {
    return;
  }

  // üè¢ 2. –ü–†–û–í–ï–†–ö–ê –≠–¢–ê–ñ–ê (–ù–û–í–û–ï)
  if (!LevelPolicy.canInteract(object)) {
    // –û–±—ä–µ–∫—Ç –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–º —ç—Ç–∞–∂–µ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é
    CursorManager.inst().setCursor('not-allowed');
    return;
  }

  // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Policy —Ä–µ–∂–∏–º–∞
  const mode = this.modeManager.getCurrentMode();
  if (!mode.policy.allows(action, objectType)) {
    return;
  }

  // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ Capability
  if (!hasCapability(object, action)) {
    return;
  }

  // 5. –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Feature
  const feature = this.features.get(objectType);
  if (feature && feature.enabled) {
    feature.handle(event, object);
  }
}
```

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –ø–æ—Ç–æ–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USER INPUT (Mouse, Keyboard, Touch)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  INPUT LAYER: MouseInputManager, KeyboardInputManager       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ROUTING LAYER: ClickRouter, RaycastService                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üè¢ LEVEL CHECK: LevelPolicy.canInteract(object)            ‚îÇ
‚îÇ  - –ü–æ–ª—É—á–∞–µ–º levelId –æ–±—ä–µ–∫—Ç–∞                                 ‚îÇ
‚îÇ  - –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å activeLevel                                 ‚îÇ
‚îÇ  - –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí –ë–õ–û–ö ‚ùå                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì (–µ—Å–ª–∏ —ç—Ç–∞–∂ –∞–∫—Ç–∏–≤–Ω—ã–π)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  POLICY CHECK: Camera2DPolicy / Camera3DPolicy              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CAPABILITY CHECK: Draggable? Selectable? Resizable?        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FEATURE ‚Üí HANDLER ‚Üí COMMAND                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç—Ç–∞–∂–∞–º–∏

```typescript
// ui/panels/LevelPanel.ts
export class LevelPanel extends ContextSingleton {
  private container: HTMLElement;
  private levelList: HTMLElement;

  init(parentContainer: HTMLElement) {
    this.container = document.createElement('div');
    this.container.className = 'level-panel';
    this.container.innerHTML = `
      <div class="level-panel__header">
        <h3>–≠—Ç–∞–∂–∏</h3>
        <button class="level-panel__add-btn" title="–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–∂">+</button>
      </div>
      <div class="level-panel__list"></div>
      <div class="level-panel__visibility">
        <label>
          <input type="checkbox" id="show-below-levels" checked>
          –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∏–∂–Ω–∏–µ —ç—Ç–∞–∂–∏
        </label>
      </div>
    `;

    parentContainer.appendChild(this.container);
    this.levelList = this.container.querySelector('.level-panel__list')!;

    this.bindEvents();
    this.render();

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
    EventBus.on('level:created', this.render);
    EventBus.on('level:deleted', this.render);
    EventBus.on('level:changed', this.render);
  }

  private render = () => {
    const levels = LevelManager.inst().getAllLevels().reverse(); // –°–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
    const activeId = LevelManager.inst().getActiveLevel()?.id;

    this.levelList.innerHTML = levels.map(level => `
      <div class="level-item ${level.id === activeId ? 'level-item--active' : ''}"
           data-level-id="${level.id}">
        <span class="level-item__name">${level.name}</span>
        <span class="level-item__elevation">${level.elevation.toFixed(1)}–º</span>
        <div class="level-item__actions">
          <button class="level-item__visibility-btn"
                  data-action="toggle-visibility"
                  title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å">
            üëÅ
          </button>
          <button class="level-item__delete-btn"
                  data-action="delete"
                  title="–£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–∂"
                  ${level.id === activeId ? 'disabled' : ''}>
            üóë
          </button>
        </div>
      </div>
    `).join('');
  }

  private bindEvents() {
    // –ö–ª–∏–∫ –ø–æ —ç—Ç–∞–∂—É - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
    this.levelList.addEventListener('click', (e) => {
      const levelItem = (e.target as HTMLElement).closest('.level-item');
      if (!levelItem) return;

      const levelId = levelItem.getAttribute('data-level-id');
      if (!levelId) return;

      const action = (e.target as HTMLElement).getAttribute('data-action');

      if (action === 'delete') {
        this.handleDelete(levelId);
      } else if (action === 'toggle-visibility') {
        this.handleToggleVisibility(levelId);
      } else {
        // –ö–ª–∏–∫ –ø–æ —Å–∞–º–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∞–∂–∞
        LevelManager.inst().setActiveLevel(levelId);
      }
    });

    // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç—Ç–∞–∂–∞
    this.container.querySelector('.level-panel__add-btn')?.addEventListener('click', () => {
      this.handleAddLevel();
    });

    // –ß–µ–∫–±–æ–∫—Å –ø–æ–∫–∞–∑–∞ –Ω–∏–∂–Ω–∏—Ö —ç—Ç–∞–∂–µ–π
    this.container.querySelector('#show-below-levels')?.addEventListener('change', (e) => {
      const checked = (e.target as HTMLInputElement).checked;
      LevelVisibility.inst().setSettings({ showBelowLevels: checked });
    });
  }

  private handleAddLevel() {
    const levels = LevelManager.inst().getAllLevels();
    const topLevel = levels[levels.length - 1];

    const newId = `level-${Date.now()}`;
    const newElevation = topLevel ? topLevel.elevation + topLevel.height : 0;

    LevelManager.inst().createLevel(newId, {
      name: `–≠—Ç–∞–∂ ${levels.length + 1}`,
      elevation: newElevation
    });

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–π —ç—Ç–∞–∂
    LevelManager.inst().setActiveLevel(newId);
  }

  private handleDelete(levelId: string) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–∂? –í—Å–µ –æ–±—ä–µ–∫—Ç—ã –Ω–∞ –Ω—ë–º –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
      LevelManager.inst().deleteLevel(levelId);
    }
  }

  private handleToggleVisibility(levelId: string) {
    const level = LevelManager.inst().getLevel(levelId);
    if (!level) return;

    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–µ–∂–¥—É 'ghost' –∏ 'hidden'
    const currentMode = level.container.visible ? 'ghost' : 'hidden';
    const newMode = currentMode === 'ghost' ? 'hidden' : 'ghost';

    LevelVisibility.inst().setVisibility(level, newMode);
  }
}
```

### –°–æ–±—ã—Ç–∏—è —ç—Ç–∞–∂–µ–π

```typescript
// –°–æ–±—ã—Ç–∏—è –¥–ª—è EventBus, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–∞–∂–∞–º–∏
interface LevelEvents {
  'level:created': { level: Level };
  'level:deleted': { levelId: string };
  'level:changed': { from: string | undefined; to: string };
  'level:visibility': { levelId: string; mode: VisibilityMode };
  'object:level-changed': { object: THREE.Object3D; levelId: string };
}
```

### Commands –¥–ª—è —ç—Ç–∞–∂–µ–π

```typescript
// commands/CreateLevelCommand.ts
export class CreateLevelCommand implements Command {
  private level: Level | null = null;

  constructor(
    private levelId: string,
    private options: LevelOptions
  ) {}

  execute() {
    this.level = LevelManager.inst().createLevel(this.levelId, this.options);
  }

  undo() {
    if (this.level) {
      LevelManager.inst().deleteLevel(this.level.id);
      this.level = null;
    }
  }

  redo() {
    this.execute();
  }
}

// commands/DeleteLevelCommand.ts
export class DeleteLevelCommand implements Command {
  private levelData: LevelSerializedData | null = null;

  constructor(private levelId: string) {}

  execute() {
    const level = LevelManager.inst().getLevel(this.levelId);
    if (level) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —ç—Ç–∞–∂–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
      this.levelData = level.serialize();
      LevelManager.inst().deleteLevel(this.levelId);
    }
  }

  undo() {
    if (this.levelData) {
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç—Ç–∞–∂ –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      LevelManager.inst().restoreLevelFromData(this.levelData);
    }
  }

  redo() {
    this.execute();
  }
}

// commands/ChangeLevelCommand.ts
export class ChangeLevelCommand implements Command {
  constructor(
    private object: THREE.Object3D,
    private fromLevelId: string,
    private toLevelId: string
  ) {}

  execute() {
    const fromLevel = LevelManager.inst().getLevel(this.fromLevelId);
    const toLevel = LevelManager.inst().getLevel(this.toLevelId);

    if (fromLevel && toLevel) {
      // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ–±—ä–µ–∫—Ç –º–µ–∂–¥—É —ç—Ç–∞–∂–∞–º–∏
      fromLevel.container.remove(this.object);
      toLevel.container.add(this.object);

      // –û–±–Ω–æ–≤–ª—è–µ–º levelId
      this.object.userData.levelId = this.toLevelId;

      // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º Y –ø–æ–∑–∏—Ü–∏—é
      const heightDiff = toLevel.elevation - fromLevel.elevation;
      this.object.position.y += heightDiff;
    }
  }

  undo() {
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ from –∏ to
    const temp = this.fromLevelId;
    this.fromLevelId = this.toLevelId;
    this.toLevelId = temp;

    this.execute();

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
    const temp2 = this.fromLevelId;
    this.fromLevelId = this.toLevelId;
    this.toLevelId = temp2;
  }

  redo() {
    this.execute();
  }
}
```

### –î–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫ –ø–æ—Ä—è–¥–∫—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –§–∞–∑–∞ 15: –°–∏—Å—Ç–µ–º–∞ —ç—Ç–∞–∂–µ–π (2-3 –¥–Ω—è)
- [ ] `Level` –∫–ª–∞—Å—Å
- [ ] `LevelManager`
- [ ] `LevelContext`
- [ ] `LevelVisibility`
- [ ] `LevelPolicy`
- [ ] `LevelBound` capability
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `InteractionOrchestrator`
- [ ] `LevelPanel` UI
- [ ] Commands –¥–ª—è —ç—Ç–∞–∂–µ–π (`CreateLevelCommand`, `DeleteLevelCommand`)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —ç—Ç–∞–∂–µ–π
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ç–∞–∂–µ–π

---

## üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—Ç–æ–∫ 1: –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –≤ 2D —Ä–µ–∂–∏–º–µ

```
1. User clicks on point
   ‚Üì
2. MouseInputManager captures pointerdown
   ‚Üì
3. ClickRouter performs raycasting
   ‚Üì
4. ObjectIdentifier: type = 'point'
   ‚Üì
5. Camera2DPolicy.allows('drag', 'point') ‚Üí true
   ‚Üì
6. Check point.userData.capabilities includes 'draggable' ‚Üí true
   ‚Üì
7. PointFeature.handle({ action: 'drag' })
   ‚Üì
8. PointDragHandler.handleMouseDown()
   - Uses DragBehavior.startDrag()
   ‚Üì
9. User moves mouse
   ‚Üì
10. MouseInputManager captures pointermove
    ‚Üì
11. PointDragHandler.handleMouseMove()
    - Uses DragBehavior.updateDrag()
    - Uses SnapBehavior.snapToGrid()
    - Updates point position
    ‚Üì
12. User releases mouse
    ‚Üì
13. PointDragHandler.handleMouseUp()
    - Creates MoveCommand(point, oldPos, newPos)
    - CommandManager.execute(command)
    ‚Üì
14. EventBus.emit('object:moved', { object: point })
```

### –ü–æ—Ç–æ–∫ 2: –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å –æ–±—ä–µ–∫—Ç –≤ 2D —Ä–µ–∂–∏–º–µ (–∑–∞–ø—Ä–µ—â–µ–Ω–æ)

```
1. User clicks on 3D object
   ‚Üì
2. MouseInputManager captures pointerdown
   ‚Üì
3. ClickRouter performs raycasting
   ‚Üì
4. ObjectIdentifier: type = 'object'
   ‚Üì
5. Camera2DPolicy.allows('drag', 'object') ‚Üí false ‚ùå
   ‚Üì
6. Interaction blocked, no further action
```

### –ü–æ—Ç–æ–∫ 3: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã 2D ‚Üí 3D

```
1. User clicks camera toggle button
   ‚Üì
2. CameraManager.switchToCamera3D()
   ‚Üì
3. EventBus.emit('camera:switched', { cameraMode: '3D' })
   ‚Üì
4. InteractionOrchestrator receives event
   ‚Üì
5. ModeManager.setMode(new Camera3DMode())
   ‚Üì
6. Camera3DMode.onActivate()
   - Changes policy to Camera3DPolicy
   - Enables features: ['objects', 'roofs']
   - Disables features: ['points', 'walls']
   ‚Üì
7. PointFeature.disable()
   - All point handlers stop listening
   ‚Üì
8. ObjectFeature.enable()
   - Object handlers start listening
   ‚Üì
9. EventBus.emit('mode:changed', { mode: '3D' })
```

### –ü–æ—Ç–æ–∫ 4: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∞–∂–∞

```
1. User clicks on level in LevelPanel
   ‚Üì
2. LevelPanel calls LevelManager.setActiveLevel(levelId)
   ‚Üì
3. LevelManager deactivates previous level
   - prevLevel.setActive(false)
   - LevelVisibility.setVisibility(prevLevel, 'ghost')
   ‚Üì
4. LevelManager activates new level
   - newLevel.setActive(true)
   - LevelVisibility.setVisibility(newLevel, 'full')
   ‚Üì
5. BlockingManager.setLevelBlock(levelId)
   - All objects on inactive levels are now blocked
   ‚Üì
6. EventBus.emit('level:changed', { from, to })
   ‚Üì
7. UI components react to event
   - LevelPanel updates active state
   - PropertiesPanel clears selection
   ‚Üì
8. Next interaction: LevelPolicy.canInteract() checks levelId
```

### –ü–æ—Ç–æ–∫ 5: –ü–æ–ø—ã—Ç–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –æ–±—ä–µ–∫—Ç–æ–º –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–º —ç—Ç–∞–∂–µ

```
1. User clicks on object (on inactive level)
   ‚Üì
2. MouseInputManager captures pointerdown
   ‚Üì
3. ClickRouter performs raycasting
   - Finds object on inactive level
   ‚Üì
4. ObjectIdentifier: type = 'wall', levelId = 'level-2'
   ‚Üì
5. LevelPolicy.canInteract(object)
   - activeLevel = 'level-1'
   - objectLevel = 'level-2'
   - Returns false ‚ùå
   ‚Üì
6. InteractionOrchestrator blocks interaction
   - CursorManager.setCursor('not-allowed')
   - No further processing
```

### –ü–æ—Ç–æ–∫ 6: Undo/Redo

```
Undo:
1. User presses Ctrl+Z
   ‚Üì
2. KeyboardInputManager detects shortcut
   ‚Üì
3. CommandManager.undo()
   ‚Üì
4. Get command from history[currentIndex]
   ‚Üì
5. command.undo() - reverts changes
   ‚Üì
6. currentIndex--
   ‚Üì
7. EventBus.emit('history:changed', { canUndo, canRedo })

Redo:
1. User presses Ctrl+Y
   ‚Üì
2. KeyboardInputManager detects shortcut
   ‚Üì
3. CommandManager.redo()
   ‚Üì
4. currentIndex++
   ‚Üì
5. Get command from history[currentIndex]
   ‚Üì
6. command.redo() - reapplies changes
   ‚Üì
7. EventBus.emit('history:changed', { canUndo, canRedo })
```

---

## üìö –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã

```typescript
// main.ts
import { InteractionOrchestrator } from '@/threeApp/interaction/core/InteractionOrchestrator';
import { ModeManager } from '@/threeApp/interaction/modes/ModeManager';
import { Camera2DMode } from '@/threeApp/interaction/modes/Camera2DMode';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ ThreeMain
export class ThreeMain extends ContextSingleton {
  init() {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
    InteractionOrchestrator.inst().init();

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    ModeManager.inst().setMode(new Camera2DMode());
  }
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏

```typescript
// house/points/PointsManager.ts
import { applyCapabilities } from '@/threeApp/interaction/capabilities/utils';
import { Draggable } from '@/threeApp/interaction/capabilities/Draggable';
import { Selectable } from '@/threeApp/interaction/capabilities/Selectable';
import { Snappable } from '@/threeApp/interaction/capabilities/Snappable';

export class PointsManager extends ContextSingleton {
  createPoint(x: number, y: number, z: number): PointWall {
    const point = new PointWall(x, y, z);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
    applyCapabilities(point.mesh, [
      new Draggable(),
      new Selectable(),
      new Snappable(),
      new Deletable()
    ]);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞
    point.mesh.userData.tag = 'point';

    return point;
  }
}
```

### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞–º–µ—Ä—ã

```typescript
// scene/CameraManager.ts
import { EventBus } from '@/threeApp/interaction/core/EventBus';

export class CameraManager extends ContextSingleton {
  switchCamera(to2D: boolean) {
    if (to2D) {
      this.activeCamera = this.camera2D;
      // ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã ...
      EventBus.emit('camera:switched', { cameraMode: '2D' });
    } else {
      this.activeCamera = this.camera3D;
      // ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã ...
      EventBus.emit('camera:switched', { cameraMode: '3D' });
    }
  }
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ custom Handler

```typescript
// features/walls/WallSplitHandler.ts
import { DragBehavior } from '@/threeApp/interaction/behaviors/DragBehavior';
import { CommandManager } from '@/threeApp/interaction/commands/CommandManager';
import { SplitWallCommand } from '@/threeApp/interaction/commands/SplitWallCommand';

export class WallSplitHandler {
  private isActive = false;

  enable() {
    this.isActive = true;
  }

  disable() {
    this.isActive = false;
  }

  handle(event: PointerEvent, wall: THREE.Object3D) {
    if (!this.isActive) return;

    // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É –∫–ª–∏–∫–∞ –Ω–∞ —Å—Ç–µ–Ω–µ
    const intersection = RaycastService.inst().getIntersection(event);
    if (!intersection) return;

    const splitPoint = intersection.point;

    // –°–æ–∑–¥–∞—ë–º –∫–æ–º–∞–Ω–¥—É —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
    const command = new SplitWallCommand(wall, splitPoint);
    CommandManager.inst().execute(command);
  }
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ custom Command

```typescript
// commands/SplitWallCommand.ts
export class SplitWallCommand implements Command {
  private newPoint: PointWall | null = null;
  private newWall: Wall | null = null;

  constructor(
    private originalWall: Wall,
    private splitPoint: THREE.Vector3
  ) {}

  execute() {
    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Ç–æ—á–∫—É –≤ –º–µ—Å—Ç–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
    this.newPoint = PointsManager.inst().createPoint(
      this.splitPoint.x,
      this.splitPoint.y,
      this.splitPoint.z
    );

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É
    const originalEndPoint = this.originalWall.endPoint;

    // –ú–µ–Ω—è–µ–º –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç–µ–Ω—ã
    this.originalWall.endPoint = this.newPoint;
    this.originalWall.updateGeometry();

    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å—Ç–µ–Ω—É –æ—Ç –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏ –¥–æ –∏—Å—Ö–æ–¥–Ω–æ–π –∫–æ–Ω–µ—á–Ω–æ–π
    this.newWall = WallsManager.inst().createWall(
      this.newPoint,
      originalEndPoint
    );

    EventBus.emit('wall:split', {
      original: this.originalWall,
      new: this.newWall
    });
  }

  undo() {
    // –£–¥–∞–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç–µ–Ω—É
    WallsManager.inst().deleteWall(this.newWall);
    this.newWall = null;

    // –£–¥–∞–ª—è–µ–º –Ω–æ–≤—É—é —Ç–æ—á–∫—É
    PointsManager.inst().deletePoint(this.newPoint);

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç–µ–Ω—É
    // (—Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ originalEndPoint –≤ execute)
    this.originalWall.updateGeometry();
  }

  redo() {
    this.execute();
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

```typescript
// ui/toolbar/Toolbar.ts
import { ToolManager } from '@/threeApp/interaction/tools/ToolManager';

export class Toolbar {
  private measureButton: HTMLButtonElement;

  init() {
    this.measureButton = document.getElementById('measure-tool');

    this.measureButton.addEventListener('click', () => {
      ToolManager.inst().activateTool('measure');
      this.setActiveButton(this.measureButton);
    });
  }

  private setActiveButton(button: HTMLButtonElement) {
    // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll('.tool-button').forEach(btn => {
      btn.classList.remove('active');
    });
    button.classList.add('active');
  }
}
```

### –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ EventBus

```typescript
// ui/panels/PropertiesPanel.ts
import { EventBus } from '@/threeApp/interaction/core/EventBus';

export class PropertiesPanel {
  init() {
    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
    EventBus.on('selection:changed', this.updatePanel);

    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è Undo/Redo –∫–Ω–æ–ø–æ–∫
    EventBus.on('history:changed', this.updateHistoryButtons);
  }

  private updatePanel = (data: { selected: THREE.Object3D[] }) => {
    if (data.selected.length === 0) {
      this.hide();
    } else if (data.selected.length === 1) {
      this.showProperties(data.selected[0]);
    } else {
      this.showMultipleSelection(data.selected);
    }
  }

  private updateHistoryButtons = (data: { canUndo: boolean, canRedo: boolean }) => {
    this.undoButton.disabled = !data.canUndo;
    this.redoButton.disabled = !data.canRedo;
  }
}
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫

1. –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ `src/threeApp/interaction/`
2. –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã:
   - `Mode.ts`, `InteractionPolicy.ts`, `Capability.ts`, `Feature.ts`, `Command.ts`

### –≠—Ç–∞–ø 2: –ú–∏–≥—Ä–∞—Ü–∏—è MouseManager ‚Üí MouseInputManager

**–ë—ã–ª–æ:**
```typescript
// scene/MouseManager.ts
export class MouseManager {
  private canvas: HTMLCanvasElement;

  init() {
    this.canvas.addEventListener('pointermove', this.onPointerMove);
    this.canvas.addEventListener('pointerdown', this.onPointerDown);
    this.canvas.addEventListener('pointerup', this.onPointerUp);
  }

  private onPointerMove = (event: PointerEvent) => {
    // –°—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ—Ç PointMove
    PointMove.inst().onPointerMove(event);
  }
}
```

**–°—Ç–∞–ª–æ:**
```typescript
// interaction/input/MouseInputManager.ts
export class MouseInputManager extends ContextSingleton {
  init() {
    // –¢–∞–∫–∞—è –∂–µ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
    // –ù–æ –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ ClickRouter –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞
  }

  private onPointerMove = (event: PointerEvent) => {
    ClickRouter.inst().route('pointermove', event);
  }
}
```

### –≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ ClickRouter

```typescript
// interaction/routing/ClickRouter.ts
export class ClickRouter extends ContextSingleton {
  private raycaster = new RaycastService();

  route(eventType: string, event: PointerEvent) {
    // 1. Raycasting
    const intersection = this.raycaster.getIntersection(event);
    if (!intersection) return;

    const object = intersection.object;

    // 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞
    const objectType = ObjectIdentifier.getType(object);

    // 3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
    const action = this.getActionFromEventType(eventType);

    // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Orchestrator
    InteractionOrchestrator.inst().handleInteraction({
      objectType,
      action,
      event,
      object
    });
  }
}
```

### –≠—Ç–∞–ø 4: –ü–µ—Ä–µ–Ω–æ—Å PointMove ‚Üí PointDragHandler

**–ë—ã–ª–æ:**
```typescript
// house/points/PointMove.ts
export class PointMove extends ContextSingleton {
  private isDown = false;
  private selectedPoint: PointWall | null = null;

  onPointerDown(event: PointerEvent) {
    // Raycasting
    const intersection = this.raycast(event);
    if (!intersection) return;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞
    if (intersection.object.userData.tag !== 'point') return;

    this.isDown = true;
    this.selectedPoint = intersection.object;
    // ... —Å–æ–∑–¥–∞–Ω–∏–µ plane ...
  }

  onPointerMove(event: PointerEvent) {
    if (!this.isDown) return;
    // ... –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è ...
  }
}
```

**–°—Ç–∞–ª–æ:**
```typescript
// interaction/features/points/PointDragHandler.ts
export class PointDragHandler {
  private dragBehavior = new DragBehavior();
  private snapBehavior = new SnapBehavior();
  private selectedPoint: THREE.Object3D | null = null;
  private originalPosition: THREE.Vector3 | null = null;

  handleMouseDown(event: PointerEvent, object: THREE.Object3D) {
    this.selectedPoint = object;
    this.originalPosition = object.position.clone();
    this.dragBehavior.startDrag(object, event);
  }

  handleMouseMove(event: PointerEvent) {
    if (!this.selectedPoint) return;

    let newPos = this.dragBehavior.updateDrag(this.selectedPoint, event);
    newPos = this.snapBehavior.snapToGrid(newPos, 0.1);

    this.selectedPoint.position.copy(newPos);
  }

  handleMouseUp() {
    if (!this.selectedPoint || !this.originalPosition) return;

    const command = new MoveCommand(
      this.selectedPoint,
      this.originalPosition,
      this.selectedPoint.position.clone()
    );

    CommandManager.inst().execute(command);

    this.selectedPoint = null;
    this.originalPosition = null;
  }
}
```

### –≠—Ç–∞–ø 5: –°–æ–∑–¥–∞–Ω–∏–µ PointFeature

```typescript
// interaction/features/points/PointFeature.ts
export class PointFeature extends Feature {
  name = 'points';

  init() {
    this.handlers.set('drag', new PointDragHandler());
    this.handlers.set('snap', new PointSnapHandler());
  }

  handle(event: any, object: THREE.Object3D) {
    if (!this.enabled) return;

    const handler = this.handlers.get('drag') as PointDragHandler;

    if (event.type === 'pointerdown') {
      handler.handleMouseDown(event, object);
    } else if (event.type === 'pointermove') {
      handler.handleMouseMove(event);
    } else if (event.type === 'pointerup') {
      handler.handleMouseUp();
    }
  }
}
```

### –≠—Ç–∞–ø 6: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Capabilities –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ–±—ä–µ–∫—Ç–∞–º

```typescript
// house/points/PointWall.ts (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å)
import { applyCapabilities } from '@/threeApp/interaction/capabilities/utils';
import { Draggable, Selectable, Snappable } from '@/threeApp/interaction/capabilities';

export class PointWall {
  mesh: THREE.Mesh;

  constructor(x: number, y: number, z: number) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è mesh ...

    // –î–æ–±–∞–≤–ª—è–µ–º capabilities
    applyCapabilities(this.mesh, [
      new Draggable(),
      new Selectable(),
      new Snappable()
    ]);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø
    this.mesh.userData.tag = 'point';
  }
}
```

### –≠—Ç–∞–ø 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CameraManager

```typescript
// scene/CameraManager.ts (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
import { EventBus } from '@/threeApp/interaction/core/EventBus';

export class CameraManager extends ContextSingleton {
  switchCamera(to2D: boolean) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ ...

    // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
    EventBus.emit('camera:switched', {
      cameraMode: to2D ? '2D' : '3D'
    });
  }
}
```

### –≠—Ç–∞–ø 8: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

1. **WallBuilder** ‚Üí **WallFeature** —Å handlers (drag, resize, split)
2. **ObjectsManager** ‚Üí **ObjectFeature** —Å handlers (place, drag, rotate)
3. –î–æ–±–∞–≤–∏—Ç—å **RoomFeature**, **DWFeature** (–¥–≤–µ—Ä–∏/–æ–∫–Ω–∞), **RoofFeature**

---

## üéØ –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –§—É–Ω–¥–∞–º–µ–Ω—Ç (1-2 –¥–Ω—è)
- [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
- [ ] –ë–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã: `Mode`, `InteractionPolicy`, `Capability`, `Feature`, `Command`
- [ ] `EventBus`
- [ ] `InteractionContext`
- [ ] `CursorManager`

### –§–∞–∑–∞ 2: –°–ª–æ–π –≤–≤–æ–¥–∞ (1 –¥–µ–Ω—å)
- [ ] `MouseInputManager` (–º–∏–≥—Ä–∞—Ü–∏—è –∏–∑ `MouseManager`)
- [ ] `KeyboardInputManager`
- [ ] `GestureDetector` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –§–∞–∑–∞ 3: –°–ª–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (1 –¥–µ–Ω—å)
- [ ] `RaycastService`
- [ ] `ObjectIdentifier`
- [ ] `ClickRouter`

### –§–∞–∑–∞ 4: –†–µ–∂–∏–º—ã –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ (1 –¥–µ–Ω—å)
- [ ] `ModeManager`
- [ ] `Camera2DMode`, `Camera3DMode`
- [ ] `Camera2DPolicy`, `Camera3DPolicy`
- [ ] `PolicyRegistry`

### –§–∞–∑–∞ 5: Capabilities (1 –¥–µ–Ω—å)
- [ ] –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Capability`
- [ ] `Draggable`, `Selectable`, `Snappable`
- [ ] –£—Ç–∏–ª–∏—Ç—ã `applyCapabilities`, `hasCapability`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ (PointWall, Wall)

### –§–∞–∑–∞ 6: Commands (1-2 –¥–Ω—è)
- [ ] `CommandManager`
- [ ] `Command` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- [ ] `MoveCommand`, `DeleteCommand`, `AddCommand`
- [ ] –¢–µ—Å—Ç—ã Undo/Redo

### –§–∞–∑–∞ 7: Behaviors (1 –¥–µ–Ω—å)
- [ ] `DragBehavior`
- [ ] `SnapBehavior`
- [ ] `HoverBehavior`
- [ ] `OutlineBehavior`

### –§–∞–∑–∞ 8: Features - Points (2 –¥–Ω—è)
- [ ] `PointFeature`
- [ ] `PointDragHandler` (–º–∏–≥—Ä–∞—Ü–∏—è –∏–∑ `PointMove`)
- [ ] `PointSnapHandler`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

### –§–∞–∑–∞ 9: Features - Walls (2-3 –¥–Ω—è)
- [ ] `WallFeature`
- [ ] `WallDragHandler`
- [ ] `WallResizeHandler`
- [ ] `WallSplitHandler`

### –§–∞–∑–∞ 10: –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (1 –¥–µ–Ω—å)
- [ ] `InteractionOrchestrator`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è

### –§–∞–∑–∞ 11: Tools (1-2 –¥–Ω—è)
- [ ] `ToolManager`
- [ ] `MeasureTool`
- [ ] `SelectionTool`
- [ ] `TransformTool`

### –§–∞–∑–∞ 12: –û—Å—Ç–∞–ª—å–Ω—ã–µ Features (3-4 –¥–Ω—è)
- [ ] `ObjectFeature` (–º–µ–±–µ–ª—å)
- [ ] `RoomFeature`
- [ ] `DWFeature` (–¥–≤–µ—Ä–∏/–æ–∫–Ω–∞)
- [ ] `RoofFeature`

### –§–∞–∑–∞ 13: Blocking System (1 –¥–µ–Ω—å)
- [ ] `BlockingManager`
- [ ] `BlockingRules`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Features

### –§–∞–∑–∞ 14: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ (2-3 –¥–Ω—è)
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –§–∞–∑–∞ 15: –°–∏—Å—Ç–µ–º–∞ —ç—Ç–∞–∂–µ–π (2-3 –¥–Ω—è)
- [ ] `Level` –∫–ª–∞—Å—Å
- [ ] `LevelManager`
- [ ] `LevelContext`
- [ ] `LevelVisibility`
- [ ] `LevelPolicy`
- [ ] `LevelBound` capability
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `InteractionOrchestrator`
- [ ] `LevelPanel` UI
- [ ] Commands –¥–ª—è —ç—Ç–∞–∂–µ–π (`CreateLevelCommand`, `DeleteLevelCommand`)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —ç—Ç–∞–∂–µ–π –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

---

## üìñ –ò—Ç–æ–≥–æ

**–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: ~23-28 –¥–Ω–µ–π**

–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:

‚úÖ **–ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** –º–µ–∂–¥—É —Å–ª–æ—è–º–∏
‚úÖ **–õ—ë–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ** –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Ä–µ–∂–∏–º–æ–≤
‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** –∫–æ–¥–∞ —á–µ—Ä–µ–∑ Behaviors
‚úÖ **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Undo/Redo** —á–µ—Ä–µ–∑ Commands
‚úÖ **–ì–∏–±–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞** —á–µ—Ä–µ–∑ Policies
‚úÖ **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏** —á–µ—Ä–µ–∑ Capabilities
‚úÖ **–ü—Ä–æ—Å—Ç—É—é –æ—Ç–ª–∞–¥–∫—É** –±–ª–∞–≥–æ–¥–∞—Ä—è –ª–∏–Ω–µ–π–Ω–æ–º—É –ø–æ—Ç–æ–∫—É –¥–∞–Ω–Ω—ã—Ö
‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** –¥–ª—è –±—É–¥—É—â–∏—Ö —Ñ–∏—á
‚úÖ **–ú–Ω–æ–≥–æ—ç—Ç–∞–∂–Ω–æ—Å—Ç—å** —Å –∏–∑–æ–ª—è—Ü–∏–µ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Levels
‚úÖ **–ì–∏–±–∫–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å** —ç—Ç–∞–∂–µ–π (ghost/wireframe/hidden)

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–æ—Å—Ç—É –ø—Ä–æ–µ–∫—Ç–∞!
